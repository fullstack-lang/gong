// generated by stacks/gong/go/models/orm_file_per_struct_back_repo.go
package orm

import (
	"database/sql"
	"errors"
	"fmt"
	"log"

	"github.com/fullstack-lang/gong/stacks/gong/go/models"
	"github.com/jinzhu/gorm"
)

// dummy variable to have the import database/sql wihthout compile failure id no sql is used
var dummy_GongEnumValue sql.NullBool

// GongEnumValueAPI is the input in POST API
//
// for POST, API, one needs the fields of the model as well as the fields
// from associations ("Has One" and "Has Many") that are generated to
// fullfill the ORM requirements for associations
//
// swagger:model gongenumvalueAPI
type GongEnumValueAPI struct {
	models.GongEnumValue

	// insertion for fields declaration
	// Declation for basic field gongenumvalueDB.Name {{BasicKind}} (to be completed)
	Name_Data sql.NullString

	// Declation for basic field gongenumvalueDB.Value {{BasicKind}} (to be completed)
	Value_Data sql.NullString

	// Implementation of a reverse ID for field GongEnum{}.GongEnumValues []*GongEnumValue
	GongEnum_GongEnumValuesDBID sql.NullInt64

	// end of insertion
}

// GongEnumValueDB describes a gongenumvalue in the database
//
// It incorporates all fields : from the model, from the generated field for the API and the GORM ID
//
// swagger:model gongenumvalueDB
type GongEnumValueDB struct {
	gorm.Model

	GongEnumValueAPI
}

// GongEnumValueDBs arrays gongenumvalueDBs
// swagger:response gongenumvalueDBsResponse
type GongEnumValueDBs []GongEnumValueDB

// GongEnumValueDBResponse provides response
// swagger:response gongenumvalueDBResponse
type GongEnumValueDBResponse struct {
	GongEnumValueDB
}

type BackRepoGongEnumValueStruct struct {
	// stores GongEnumValueDB according to their gorm ID
	Map_GongEnumValueDBID_GongEnumValueDB *map[uint]*GongEnumValueDB

	// stores GongEnumValueDB ID according to GongEnumValue address
	Map_GongEnumValuePtr_GongEnumValueDBID *map[*models.GongEnumValue]uint

	// stores GongEnumValue according to their gorm ID
	Map_GongEnumValueDBID_GongEnumValuePtr *map[uint]*models.GongEnumValue

	db *gorm.DB
}

// BackRepoGongEnumValue.Init set up the BackRepo of the GongEnumValue
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) Init(db *gorm.DB) (Error error) {

	if backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr != nil {
		err := errors.New("In Init, backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr should be nil")
		return err
	}

	if backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB != nil {
		err := errors.New("In Init, backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB should be nil")
		return err
	}

	if backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID != nil {
		err := errors.New("In Init, backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID should be nil")
		return err
	}

	tmp := make(map[uint]*models.GongEnumValue, 0)
	backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr = &tmp

	tmpDB := make(map[uint]*GongEnumValueDB, 0)
	backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB = &tmpDB

	tmpID := make(map[*models.GongEnumValue]uint, 0)
	backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID = &tmpID

	backRepoGongEnumValue.db = db
	return
}

// BackRepoGongEnumValue.CommitPhaseOne commits all staged instances of GongEnumValue to the BackRepo
// Phase One is the creation of instance in the database if it is not yet done to get the unique ID for each staged instance
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CommitPhaseOne(stage *models.StageStruct) (Error error) {

	for gongenumvalue := range stage.GongEnumValues {
		backRepoGongEnumValue.CommitPhaseOneInstance(gongenumvalue)
	}

	// parse all backRepo instance and checks wether some instance have been unstaged
	// in this case, remove them from the back repo
	for id, gongenumvalue := range *backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr {
		if _, ok := stage.GongEnumValues[gongenumvalue]; !ok {
			backRepoGongEnumValue.CommitDeleteInstance(id)
		}
	}

	return
}

// BackRepoGongEnumValue.CommitDeleteInstance commits deletion of GongEnumValue to the BackRepo
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CommitDeleteInstance(id uint) (Error error) {

	gongenumvalue := (*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr)[id]

	// gongenumvalue is not staged anymore, remove gongenumvalueDB
	gongenumvalueDB := (*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB)[id]
	query := backRepoGongEnumValue.db.Unscoped().Delete(&gongenumvalueDB)
	if query.Error != nil {
		return query.Error
	}

	// update stores
	delete((*backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID), gongenumvalue)
	delete((*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr), id)
	delete((*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB), id)

	return
}

// BackRepoGongEnumValue.CommitPhaseOneInstance commits gongenumvalue staged instances of GongEnumValue to the BackRepo
// Phase One is the creation of instance in the database if it is not yet done to get the unique ID for each staged instance
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CommitPhaseOneInstance(gongenumvalue *models.GongEnumValue) (Error error) {

	// check if the gongenumvalue is not commited yet
	if _, ok := (*backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[gongenumvalue]; ok {
		return
	}

	// initiate gongenumvalue
	var gongenumvalueDB GongEnumValueDB
	gongenumvalueDB.GongEnumValue = *gongenumvalue

	query := backRepoGongEnumValue.db.Create(&gongenumvalueDB)
	if query.Error != nil {
		return query.Error
	}

	// update stores
	(*backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[gongenumvalue] = gongenumvalueDB.ID
	(*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr)[gongenumvalueDB.ID] = gongenumvalue
	(*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB)[gongenumvalueDB.ID] = &gongenumvalueDB

	return
}

// BackRepoGongEnumValue.CommitPhaseTwo commits all staged instances of GongEnumValue to the BackRepo
// Phase Two is the update of instance with the field in the database
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CommitPhaseTwo(backRepo *BackRepoStruct) (Error error) {

	for idx, gongenumvalue := range *backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr {
		backRepoGongEnumValue.CommitPhaseTwoInstance(backRepo, idx, gongenumvalue)
	}

	return
}

// BackRepoGongEnumValue.CommitPhaseTwoInstance commits {{structname }} of models.GongEnumValue to the BackRepo
// Phase Two is the update of instance with the field in the database
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CommitPhaseTwoInstance(backRepo *BackRepoStruct, idx uint, gongenumvalue *models.GongEnumValue) (Error error) {

	// fetch matching gongenumvalueDB
	if gongenumvalueDB, ok := (*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB)[idx]; ok {

		{
			{
				// insertion point for fields commit
				gongenumvalueDB.Name_Data.String = gongenumvalue.Name
				gongenumvalueDB.Name_Data.Valid = true

				gongenumvalueDB.Value_Data.String = gongenumvalue.Value
				gongenumvalueDB.Value_Data.Valid = true

			}
		}
		query := backRepoGongEnumValue.db.Save(&gongenumvalueDB)
		if query.Error != nil {
			return query.Error
		}

	} else {
		err := errors.New(
			fmt.Sprintf("Unkown GongEnumValue intance %s", gongenumvalue.Name))
		return err
	}

	return
}

// BackRepoGongEnumValue.CheckoutPhaseOne Checkouts all BackRepo instances to the Stage
//
// Phase One is the creation of instance in the stage
//
// NOTE: the is supposed to have been reset before
//
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CheckoutPhaseOne() (Error error) {

	gongenumvalueDBArray := make([]GongEnumValueDB, 0)
	query := backRepoGongEnumValue.db.Find(&gongenumvalueDBArray)
	if query.Error != nil {
		return query.Error
	}

	// copy orm objects to the the map
	for _, gongenumvalueDB := range gongenumvalueDBArray {
		backRepoGongEnumValue.CheckoutPhaseOneInstance(&gongenumvalueDB)
	}

	return
}

// CheckoutPhaseOneInstance takes a gongenumvalueDB that has been found in the DB, updates the backRepo and stages the
// models version of the gongenumvalueDB
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CheckoutPhaseOneInstance(gongenumvalueDB *GongEnumValueDB) (Error error) {

	// if absent, create entries in the backRepoGongEnumValue maps.
	gongenumvalueWithNewFieldValues := gongenumvalueDB.GongEnumValue
	if _, ok := (*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr)[gongenumvalueDB.ID]; !ok {

		(*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr)[gongenumvalueDB.ID] = &gongenumvalueWithNewFieldValues
		(*backRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[&gongenumvalueWithNewFieldValues] = gongenumvalueDB.ID

		// append model store with the new element
		gongenumvalueWithNewFieldValues.Stage()
	}
	gongenumvalueDBWithNewFieldValues := *gongenumvalueDB
	(*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB)[gongenumvalueDB.ID] = &gongenumvalueDBWithNewFieldValues

	return
}

// BackRepoGongEnumValue.CheckoutPhaseTwo Checkouts all staged instances of GongEnumValue to the BackRepo
// Phase Two is the update of instance with the field in the database
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CheckoutPhaseTwo(backRepo *BackRepoStruct) (Error error) {

	// parse all DB instance and update all pointer fields of the translated models instance
	for _, gongenumvalueDB := range *backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValueDB {
		backRepoGongEnumValue.CheckoutPhaseTwoInstance(backRepo, gongenumvalueDB)
	}
	return
}

// BackRepoGongEnumValue.CheckoutPhaseTwoInstance Checkouts staged instances of GongEnumValue to the BackRepo
// Phase Two is the update of instance with the field in the database
func (backRepoGongEnumValue *BackRepoGongEnumValueStruct) CheckoutPhaseTwoInstance(backRepo *BackRepoStruct, gongenumvalueDB *GongEnumValueDB) (Error error) {

	gongenumvalue := (*backRepoGongEnumValue.Map_GongEnumValueDBID_GongEnumValuePtr)[gongenumvalueDB.ID]
	_ = gongenumvalue // sometimes, there is no code generated. This lines voids the "unused variable" compilation error
	{
		{
			// insertion point for checkout, i.e. update of fields of stage instance from fields of back repo instances
			//
			gongenumvalue.Name = gongenumvalueDB.Name_Data.String

			gongenumvalue.Value = gongenumvalueDB.Value_Data.String

		}
	}
	return
}

// CommitGongEnumValue allows commit of a single gongenumvalue (if already staged)
func (backRepo *BackRepoStruct) CommitGongEnumValue(gongenumvalue *models.GongEnumValue) {
	backRepo.BackRepoGongEnumValue.CommitPhaseOneInstance(gongenumvalue)
	if id, ok := (*backRepo.BackRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[gongenumvalue]; ok {
		backRepo.BackRepoGongEnumValue.CommitPhaseTwoInstance(backRepo, id, gongenumvalue)
	}
}

// CommitGongEnumValue allows checkout of a single gongenumvalue (if already staged and with a BackRepo id)
func (backRepo *BackRepoStruct) CheckoutGongEnumValue(gongenumvalue *models.GongEnumValue) {
	// check if the gongenumvalue is staged
	if _, ok := (*backRepo.BackRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[gongenumvalue]; ok {

		if id, ok := (*backRepo.BackRepoGongEnumValue.Map_GongEnumValuePtr_GongEnumValueDBID)[gongenumvalue]; ok {
			var gongenumvalueDB GongEnumValueDB
			gongenumvalueDB.ID = id

			if err := backRepo.BackRepoGongEnumValue.db.First(&gongenumvalueDB, id).Error; err != nil {
				log.Panicln("CheckoutGongEnumValue : Problem with getting object with id:", id)
			}
			backRepo.BackRepoGongEnumValue.CheckoutPhaseOneInstance(&gongenumvalueDB)
			backRepo.BackRepoGongEnumValue.CheckoutPhaseTwoInstance(backRepo, &gongenumvalueDB)
		}
	}
}
