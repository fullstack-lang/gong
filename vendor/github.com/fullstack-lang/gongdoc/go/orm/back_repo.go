// generated by genORMTranslation.go
package orm

import (
	"bufio"
	"bytes"
	"io/ioutil"
	"log"
	"os"
	"path/filepath"

	"gorm.io/gorm"

	"github.com/fullstack-lang/gongdoc/go/models"

	"github.com/tealeg/xlsx/v3"
)

// BackRepoStruct supports callback functions
type BackRepoStruct struct {
	// insertion point for per struct back repo declarations
	BackRepoClassdiagram BackRepoClassdiagramStruct

	BackRepoDiagramPackage BackRepoDiagramPackageStruct

	BackRepoField BackRepoFieldStruct

	BackRepoGongEnumShape BackRepoGongEnumShapeStruct

	BackRepoGongEnumValueEntry BackRepoGongEnumValueEntryStruct

	BackRepoGongStructShape BackRepoGongStructShapeStruct

	BackRepoLink BackRepoLinkStruct

	BackRepoNode BackRepoNodeStruct

	BackRepoNoteShape BackRepoNoteShapeStruct

	BackRepoNoteShapeLink BackRepoNoteShapeLinkStruct

	BackRepoPosition BackRepoPositionStruct

	BackRepoTree BackRepoTreeStruct

	BackRepoUmlState BackRepoUmlStateStruct

	BackRepoUmlsc BackRepoUmlscStruct

	BackRepoVertice BackRepoVerticeStruct

	CommitFromBackNb uint // this ng is updated at the BackRepo level but also at the BackRepo<GongStruct> level

	PushFromFrontNb uint // records increments from push from front
}

func (backRepo *BackRepoStruct) GetLastCommitFromBackNb() uint {
	return backRepo.CommitFromBackNb
}

func (backRepo *BackRepoStruct) GetLastPushFromFrontNb() uint {
	return backRepo.PushFromFrontNb
}

func (backRepo *BackRepoStruct) IncrementCommitFromBackNb() uint {
	if models.Stage.OnInitCommitCallback != nil {
		models.Stage.OnInitCommitCallback.BeforeCommit(&models.Stage)
	}
	if models.Stage.OnInitCommitFromBackCallback != nil {
		models.Stage.OnInitCommitFromBackCallback.BeforeCommit(&models.Stage)
	}
	backRepo.CommitFromBackNb = backRepo.CommitFromBackNb + 1
	return backRepo.CommitFromBackNb
}

func (backRepo *BackRepoStruct) IncrementPushFromFrontNb() uint {
	if models.Stage.OnInitCommitCallback != nil {
		models.Stage.OnInitCommitCallback.BeforeCommit(&models.Stage)
	}
	if models.Stage.OnInitCommitFromFrontCallback != nil {
		models.Stage.OnInitCommitFromFrontCallback.BeforeCommit(&models.Stage)
	}
	backRepo.PushFromFrontNb = backRepo.PushFromFrontNb + 1
	return backRepo.CommitFromBackNb
}

// Init the BackRepoStruct inner variables and link to the database
func (backRepo *BackRepoStruct) init(db *gorm.DB) {
	// insertion point for per struct back repo declarations
	backRepo.BackRepoClassdiagram.Init(db)
	backRepo.BackRepoDiagramPackage.Init(db)
	backRepo.BackRepoField.Init(db)
	backRepo.BackRepoGongEnumShape.Init(db)
	backRepo.BackRepoGongEnumValueEntry.Init(db)
	backRepo.BackRepoGongStructShape.Init(db)
	backRepo.BackRepoLink.Init(db)
	backRepo.BackRepoNode.Init(db)
	backRepo.BackRepoNoteShape.Init(db)
	backRepo.BackRepoNoteShapeLink.Init(db)
	backRepo.BackRepoPosition.Init(db)
	backRepo.BackRepoTree.Init(db)
	backRepo.BackRepoUmlState.Init(db)
	backRepo.BackRepoUmlsc.Init(db)
	backRepo.BackRepoVertice.Init(db)

	models.Stage.BackRepo = backRepo
}

// Commit the BackRepoStruct inner variables and link to the database
func (backRepo *BackRepoStruct) Commit(stage *models.StageStruct) {
	// insertion point for per struct back repo phase one commit
	backRepo.BackRepoClassdiagram.CommitPhaseOne(stage)
	backRepo.BackRepoDiagramPackage.CommitPhaseOne(stage)
	backRepo.BackRepoField.CommitPhaseOne(stage)
	backRepo.BackRepoGongEnumShape.CommitPhaseOne(stage)
	backRepo.BackRepoGongEnumValueEntry.CommitPhaseOne(stage)
	backRepo.BackRepoGongStructShape.CommitPhaseOne(stage)
	backRepo.BackRepoLink.CommitPhaseOne(stage)
	backRepo.BackRepoNode.CommitPhaseOne(stage)
	backRepo.BackRepoNoteShape.CommitPhaseOne(stage)
	backRepo.BackRepoNoteShapeLink.CommitPhaseOne(stage)
	backRepo.BackRepoPosition.CommitPhaseOne(stage)
	backRepo.BackRepoTree.CommitPhaseOne(stage)
	backRepo.BackRepoUmlState.CommitPhaseOne(stage)
	backRepo.BackRepoUmlsc.CommitPhaseOne(stage)
	backRepo.BackRepoVertice.CommitPhaseOne(stage)

	// insertion point for per struct back repo phase two commit
	backRepo.BackRepoClassdiagram.CommitPhaseTwo(backRepo)
	backRepo.BackRepoDiagramPackage.CommitPhaseTwo(backRepo)
	backRepo.BackRepoField.CommitPhaseTwo(backRepo)
	backRepo.BackRepoGongEnumShape.CommitPhaseTwo(backRepo)
	backRepo.BackRepoGongEnumValueEntry.CommitPhaseTwo(backRepo)
	backRepo.BackRepoGongStructShape.CommitPhaseTwo(backRepo)
	backRepo.BackRepoLink.CommitPhaseTwo(backRepo)
	backRepo.BackRepoNode.CommitPhaseTwo(backRepo)
	backRepo.BackRepoNoteShape.CommitPhaseTwo(backRepo)
	backRepo.BackRepoNoteShapeLink.CommitPhaseTwo(backRepo)
	backRepo.BackRepoPosition.CommitPhaseTwo(backRepo)
	backRepo.BackRepoTree.CommitPhaseTwo(backRepo)
	backRepo.BackRepoUmlState.CommitPhaseTwo(backRepo)
	backRepo.BackRepoUmlsc.CommitPhaseTwo(backRepo)
	backRepo.BackRepoVertice.CommitPhaseTwo(backRepo)

	backRepo.IncrementCommitFromBackNb()
}

// Checkout the database into the stage
func (backRepo *BackRepoStruct) Checkout(stage *models.StageStruct) {
	// insertion point for per struct back repo phase one commit
	backRepo.BackRepoClassdiagram.CheckoutPhaseOne()
	backRepo.BackRepoDiagramPackage.CheckoutPhaseOne()
	backRepo.BackRepoField.CheckoutPhaseOne()
	backRepo.BackRepoGongEnumShape.CheckoutPhaseOne()
	backRepo.BackRepoGongEnumValueEntry.CheckoutPhaseOne()
	backRepo.BackRepoGongStructShape.CheckoutPhaseOne()
	backRepo.BackRepoLink.CheckoutPhaseOne()
	backRepo.BackRepoNode.CheckoutPhaseOne()
	backRepo.BackRepoNoteShape.CheckoutPhaseOne()
	backRepo.BackRepoNoteShapeLink.CheckoutPhaseOne()
	backRepo.BackRepoPosition.CheckoutPhaseOne()
	backRepo.BackRepoTree.CheckoutPhaseOne()
	backRepo.BackRepoUmlState.CheckoutPhaseOne()
	backRepo.BackRepoUmlsc.CheckoutPhaseOne()
	backRepo.BackRepoVertice.CheckoutPhaseOne()

	// insertion point for per struct back repo phase two commit
	backRepo.BackRepoClassdiagram.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoDiagramPackage.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoField.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoGongEnumShape.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoGongEnumValueEntry.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoGongStructShape.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoLink.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoNode.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoNoteShape.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoNoteShapeLink.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoPosition.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoTree.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoUmlState.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoUmlsc.CheckoutPhaseTwo(backRepo)
	backRepo.BackRepoVertice.CheckoutPhaseTwo(backRepo)
}

var BackRepo BackRepoStruct

func GetLastCommitFromBackNb() uint {
	return BackRepo.GetLastCommitFromBackNb()
}

func GetLastPushFromFrontNb() uint {
	return BackRepo.GetLastPushFromFrontNb()
}

// Backup the BackRepoStruct
func (backRepo *BackRepoStruct) Backup(stage *models.StageStruct, dirPath string) {
	os.MkdirAll(dirPath, os.ModePerm)

	// insertion point for per struct backup
	backRepo.BackRepoClassdiagram.Backup(dirPath)
	backRepo.BackRepoDiagramPackage.Backup(dirPath)
	backRepo.BackRepoField.Backup(dirPath)
	backRepo.BackRepoGongEnumShape.Backup(dirPath)
	backRepo.BackRepoGongEnumValueEntry.Backup(dirPath)
	backRepo.BackRepoGongStructShape.Backup(dirPath)
	backRepo.BackRepoLink.Backup(dirPath)
	backRepo.BackRepoNode.Backup(dirPath)
	backRepo.BackRepoNoteShape.Backup(dirPath)
	backRepo.BackRepoNoteShapeLink.Backup(dirPath)
	backRepo.BackRepoPosition.Backup(dirPath)
	backRepo.BackRepoTree.Backup(dirPath)
	backRepo.BackRepoUmlState.Backup(dirPath)
	backRepo.BackRepoUmlsc.Backup(dirPath)
	backRepo.BackRepoVertice.Backup(dirPath)
}

// Backup in XL the BackRepoStruct
func (backRepo *BackRepoStruct) BackupXL(stage *models.StageStruct, dirPath string) {
	os.MkdirAll(dirPath, os.ModePerm)

	// open an existing file
	file := xlsx.NewFile()

	// insertion point for per struct backup
	backRepo.BackRepoClassdiagram.BackupXL(file)
	backRepo.BackRepoDiagramPackage.BackupXL(file)
	backRepo.BackRepoField.BackupXL(file)
	backRepo.BackRepoGongEnumShape.BackupXL(file)
	backRepo.BackRepoGongEnumValueEntry.BackupXL(file)
	backRepo.BackRepoGongStructShape.BackupXL(file)
	backRepo.BackRepoLink.BackupXL(file)
	backRepo.BackRepoNode.BackupXL(file)
	backRepo.BackRepoNoteShape.BackupXL(file)
	backRepo.BackRepoNoteShapeLink.BackupXL(file)
	backRepo.BackRepoPosition.BackupXL(file)
	backRepo.BackRepoTree.BackupXL(file)
	backRepo.BackRepoUmlState.BackupXL(file)
	backRepo.BackRepoUmlsc.BackupXL(file)
	backRepo.BackRepoVertice.BackupXL(file)

	var b bytes.Buffer
	writer := bufio.NewWriter(&b)
	file.Write(writer)
	theBytes := b.Bytes()

	filename := filepath.Join(dirPath, "bckp.xlsx")
	err := ioutil.WriteFile(filename, theBytes, 0644)
	if err != nil {
		log.Panic("Cannot write the XL file", err.Error())
	}
}

// Restore the database into the back repo
func (backRepo *BackRepoStruct) Restore(stage *models.StageStruct, dirPath string) {
	models.Stage.Commit()
	models.Stage.Reset()
	models.Stage.Checkout()

	//
	// restauration first phase (create DB instance with new IDs)
	//

	// insertion point for per struct backup
	backRepo.BackRepoClassdiagram.RestorePhaseOne(dirPath)
	backRepo.BackRepoDiagramPackage.RestorePhaseOne(dirPath)
	backRepo.BackRepoField.RestorePhaseOne(dirPath)
	backRepo.BackRepoGongEnumShape.RestorePhaseOne(dirPath)
	backRepo.BackRepoGongEnumValueEntry.RestorePhaseOne(dirPath)
	backRepo.BackRepoGongStructShape.RestorePhaseOne(dirPath)
	backRepo.BackRepoLink.RestorePhaseOne(dirPath)
	backRepo.BackRepoNode.RestorePhaseOne(dirPath)
	backRepo.BackRepoNoteShape.RestorePhaseOne(dirPath)
	backRepo.BackRepoNoteShapeLink.RestorePhaseOne(dirPath)
	backRepo.BackRepoPosition.RestorePhaseOne(dirPath)
	backRepo.BackRepoTree.RestorePhaseOne(dirPath)
	backRepo.BackRepoUmlState.RestorePhaseOne(dirPath)
	backRepo.BackRepoUmlsc.RestorePhaseOne(dirPath)
	backRepo.BackRepoVertice.RestorePhaseOne(dirPath)

	//
	// restauration second phase (reindex pointers with the new ID)
	//

	// insertion point for per struct backup
	backRepo.BackRepoClassdiagram.RestorePhaseTwo()
	backRepo.BackRepoDiagramPackage.RestorePhaseTwo()
	backRepo.BackRepoField.RestorePhaseTwo()
	backRepo.BackRepoGongEnumShape.RestorePhaseTwo()
	backRepo.BackRepoGongEnumValueEntry.RestorePhaseTwo()
	backRepo.BackRepoGongStructShape.RestorePhaseTwo()
	backRepo.BackRepoLink.RestorePhaseTwo()
	backRepo.BackRepoNode.RestorePhaseTwo()
	backRepo.BackRepoNoteShape.RestorePhaseTwo()
	backRepo.BackRepoNoteShapeLink.RestorePhaseTwo()
	backRepo.BackRepoPosition.RestorePhaseTwo()
	backRepo.BackRepoTree.RestorePhaseTwo()
	backRepo.BackRepoUmlState.RestorePhaseTwo()
	backRepo.BackRepoUmlsc.RestorePhaseTwo()
	backRepo.BackRepoVertice.RestorePhaseTwo()

	models.Stage.Checkout()
}

// Restore the database into the back repo
func (backRepo *BackRepoStruct) RestoreXL(stage *models.StageStruct, dirPath string) {

	// clean the stage
	models.Stage.Reset()

	// commit the cleaned stage
	models.Stage.Commit()

	// open an existing file
	filename := filepath.Join(dirPath, "bckp.xlsx")
	file, err := xlsx.OpenFile(filename)

	if err != nil {
		log.Panic("Cannot read the XL file", err.Error())
	}

	//
	// restauration first phase (create DB instance with new IDs)
	//

	// insertion point for per struct backup
	backRepo.BackRepoClassdiagram.RestoreXLPhaseOne(file)
	backRepo.BackRepoDiagramPackage.RestoreXLPhaseOne(file)
	backRepo.BackRepoField.RestoreXLPhaseOne(file)
	backRepo.BackRepoGongEnumShape.RestoreXLPhaseOne(file)
	backRepo.BackRepoGongEnumValueEntry.RestoreXLPhaseOne(file)
	backRepo.BackRepoGongStructShape.RestoreXLPhaseOne(file)
	backRepo.BackRepoLink.RestoreXLPhaseOne(file)
	backRepo.BackRepoNode.RestoreXLPhaseOne(file)
	backRepo.BackRepoNoteShape.RestoreXLPhaseOne(file)
	backRepo.BackRepoNoteShapeLink.RestoreXLPhaseOne(file)
	backRepo.BackRepoPosition.RestoreXLPhaseOne(file)
	backRepo.BackRepoTree.RestoreXLPhaseOne(file)
	backRepo.BackRepoUmlState.RestoreXLPhaseOne(file)
	backRepo.BackRepoUmlsc.RestoreXLPhaseOne(file)
	backRepo.BackRepoVertice.RestoreXLPhaseOne(file)

	// commit the restored stage
	models.Stage.Commit()
}
